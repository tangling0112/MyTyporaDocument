# 试验设计

## 单因子实验

- **定义**：单因子实验的目的是对一个因子的多个不同的水平对于观察值的影响是否有显著差异。

### 平衡设计与非平衡设计

- **平衡设计**：即每一个水平下的重复实验次数相同。
- **非平衡实验设计**：即每一水平下的重复实验次数不一定相同

### 偏差平方和与自由度

- $偏差平方和=\sum\limits_{i=1}^n(y_i-\bar y)^2$
  - $\bar y = \frac{1}{n}\sum \limits_{i=1}^ny_i$
- **自由度**:我们发现$\sum\limits_{i=1}^n(y_i-\bar y)=(\sum\limits_{i=1}^ny_i)-n\bar y=(\sum\limits_{i=1}^ny_i)-n(\frac{1}{n}\sum\limits_{i=1}^ny_i)=0$,因此定义偏差平方和的自由度为$n-1$

### 总平方和(`SST`),组间平方和(`SSA`)与组内平方和(`SSE`)

> $\bold{r}$:水平数
>
> $\bold{m_i}$:第`i`个水平下的重复实验次数
>
> $\bold{\bar y_i}$:第``i`水平下的均值
>
> $\bold{\bar y}$:总均值

- $SST=\sum\limits_{i=1}^r\sum\limits_{j=1}^m(y_{ij}-\bar y)^2,f_T=n-1$
- $SSA = \sum\limits_{i=1}^r\sum\limits_{j=1}^{m_i}(y_{ij}-\bar y_i)^2,f_A=r-1$
- $SSE=\sum\limits_{i=1}^rm_i(\bar y_{i}-\bar y)^2,f_E=n-r$

### 均方和`MSE`与`MSA`

> **均方和的作用**:我们这里计算的都是平方和,因此都是大于零的数相加,因此相加的项越多其值也会越大.因此我们通过引入均方和来消除项数的带来问题.

- $MSE=\frac{SSE}{f_E}$
- $MSA=\frac{SSA}{f_A}$

### 基于`F比`的假设检验

> 基本思想

### 各个水平下的均值置信区间估计

> - $\hat\sigma^2=MSE$
>
> - $\hat\mu_i=\bar y_i$

- 置信区间:$\bar y_i ±t_{1-\alpha/2}(n-r)\hat\sigma/\sqrt{m_i}$

### 各个水平的影响大小的估计

- $|\bar y_i-\bar y|>\sqrt{(r-1)F_{1-\alpha}(r-1,f_E)(\frac{1}{m_i}+\frac{1}{n})MSE}$

### 多重比较

#### 重复数相等的`T`法

> 用于重复数相等时来比较两个水平之间对观察值的影响是否有显著差异

- $|\bar y_i-\bar y_j|>q_{1-\alpha}(r,f_E)\sqrt{MSE/m}$

#### 重复数不等的`S`法

> 用于重复数目相等或不相等时比较两个水平之间对观察值的影响是否有显著差异

- $|\bar y_i-\bar y_j|>\sqrt{(r-1)F_{1-\alpha}(r-1,f_E)(\frac{1}{m_i}+\frac{1}{m_j})MSE}$

### 效应模型

> 分为`固定效应模型`与`随机效应模型(方差分量模型)`,两个模型的**计算没有差别**,只是假设方式不同.**一个只希望得出当前几个水平对于观察值影响不明显的结论,而另一个则是希望得出该因子下任何一个水平对于观察值的影响均不明显的结论**

#### 固定效应模型

> **基本假设**
>
> - 固定效应模型假设我们给出的因子的各个水平都是指定好的,**该模型的任务是考察我们指定的水平之间是否有显著差异**
>
> **固有结论**
>
> - 在各水平重复数相等时$\sum\limits_{i=1}^r a_i=0$

#### 随机效应模型

> 基本假设
>
> - 随机效应模型假设我们给出的因子的各个水平是从因子的全体水平中随机选取的,并不包含因子的全部水平.**该模型的任务是通过因子的一部分水平来考察该因子所有的水平对于我们的观察值是否有显著影响**

$\hat \sigma_a^2$的估计

## 1 区组设计

### 1.1 链式区组设计

#### 1.1.1 应用场景

当我们进行==单因子检验==时，若我们的因子$A$有大量的水平,此时如果采用一般的非平衡区组设计,会需要一个很大的实验次数.此时我们就应该考虑使用==链式区组设计==.

#### 1.1.2 链式区组设计

<img src="C:\Users\Administrator\Desktop\Typora文档\试验设计\image-20220331144246897.png" alt="image-20220331144246897" style="zoom: 25%;" />

#### 1.1.3 基本计算步骤

##### 数据预处理

1. 计算$X_i$的值$X_i=A_i$大括号包括的那几行的实验的结果的和
2. 计算$X_i^{'}$的的值$X_i^{'}=A_i^{'}$大括号包括的那几行的实验结果的和
3. 计算$D_i$的值$D_i=X_i-X_i^{'}$
4. 计算$G$的值$G=X_1+X_2+\cdots+X_b$
5. 计算$G^{'}$的值$G^{'}=X_{1}^{'}+X_2^{'}+\cdots+X_b^{'}$
6. 计算$G^{''}$的值$G^{''}=所有不被大括号包括的行的实验结果的和乘以区组数(即列数)$
7. $T=G+G^{'}+G^{''}$
8. $L_1=\sum_{i=1}^b(b-i)×(D_i-D_{i+1})$
9. $H = \frac{G^{'}-G}{mb}$,$m$为$A_i$中处理的个数(也即单个大括号包括的行数)
10. $\hat b_1=\frac{L_1}{2mb}$,$b_i=\hat b_i+\frac{D_i}{m}+H$
11. 若给定水平下有两个观察值那么$\hat {\mu}=\frac{y_i+y_i^{'}}{2}-\frac{\hat b_s+\hat b_m}{2}$,$s,m分别产生是这两个观察值的区组$
12. 若给定水平下有一个观察值那么$\hat \mu=y_i-b_s$,$s为产生这个观察值的区组$

##### 方差分析

**前提**:
$$
T=\sum_{i=1}^{v}\sum_{j=1}^{b}y_{ij}\\
SST=\sum_{i=1}^v\sum_{j=1}^{b}y_{ij}^2-\frac{T^2}{n}\\
B_j=\sum_{i=1}^{v}y_{ij}\\
k_i=第i个区组中的处理数(也即第i列的行数)
$$

1. ==$SSB=\frac{B_1^2}{k_1}+\frac{B_2^2}{k_2}+\cdots+\frac{B_b^2}{k_b}-\frac{T^2}{n},f_B=b-1$==.$SSB$即区组平方和$f_B即为区组自由度$
2. ==$SSA=SST-SSB-SSE,f_A=v-1$==
3. $d_{ij}=A_i的第j个观察值-A_{i}^{'}的第j个观察值$
4. $S_i=\frac{d_{i1^2}+d_{i2^2}+\cdots+d_{im^2}}{2}+\frac{D_i^2}{2m}$
5. $S=\frac{(G-G^{'})^2}{2bm}$
6. ==$SSE=S_1+S_2+\cdots+S_b+S,f_E=n-v-b+1$==

## 2 正交设计

### 2.1 基本知识

- **正交表特性**
  - 任何一列的不同的数字的重复次数相同
  - 任意两列的同行的两个数字组成数对,任何可能的数对的重复次数相同
- **正交表的表示:$L_a(b^c)$**
  - $a$:行数,实验数
  - $b$:表的主体部分可以出现的不同数字的个数
  - $c$:列数,因子数(==使用时空余少数列是可行的==)
- **正交表类型**
  - 完全正交表:$n=q^k,p=\frac{n-1}{q-1},n为行数,q为水平数,p为列数,k\ge2且k\in\R$
  - 非完全正交表:不满足完全正交表就是非完全正交表

### 2.2 无交互下的正交设计

#### 2.2.1 设计的基本步骤

1. 确定因子个数,水平个数
2. 确定合适的正交表
3. 按照正交表对实验进行安排

#### 2.2.2 简单方法判断因子的影响

1. 综合可比性
2. 极差分析法
3. 水平均值图

#### 2.2.3 方差分析

1. 填写计算表<img src="C:\Users\Administrator\Desktop\Typora文档\试验设计\1648889778592.jpg.jpg" alt="1648889778592.jpg" style="zoom: 20%;" />
2. ==$T_{ij}=第i列的所有数字等于j的行对应的观察值的和$==
3. $T=观察值列的所有元素的和$
4. ==$S_T=\sum_{i=1}^n(y_i-\overline y)^2,f_T=n-1,n为总行数(即实验数)$==
5. ==$\bar{T}_{ij}=第i列的j水平下的观察值的均值$==
6. ==$S_i=\frac{n}{q}\sum_{j=1}^{q}(\bar{T}_{ij}-\bar{y})^2,i=1\cdots p,n为实验次数(即行数),q为水平个数,p为因子数$==
7. $f_i=q-1$
8. $f_e=f_T-\sum_{i=1}^{p}f_i$
9. 方差分析
10. 点估计
    - $\hat \mu=\bar y$
    - $\hat a_i=\bar{T}_{1i}-\bar y$
    - $b_j=\bar{T}_{2j}-\bar y$
    - $c_k=\bar{T}_{3k}-\bar y$
    - $\hat\mu_{ijk}=\hat\mu+\hat a_i+\hat b_j+\hat c_k$
11. 区间估计
    1. $n_e=\frac{实验次数}{1+显著因子的自由度的和}$
    2. $S_e^{'}=S_e+不显著因子的平方和$
    3. $f_e^{'}=f_e+不显著的因子的自由度之和$
    4. $\hat\sigma=\sqrt{\frac{S_e^{'}}{f_e^{'}}}$
    5. $\hat\mu_{ijk}±\frac{t_{\frac{1-\alpha}{2}}(f_e^{'})\hat\sigma}{\sqrt{n_e}}$
12. 贡献率分析
    1. $\rho_i=\frac{S_i-(f_i×MSE)}{S_T}$
    2. $\rho_e=f_T×\frac{MSE}{S_T}$

### 2.3 有交互下的正交设计

#### 前提

这是一个完全正交实验

#### 表头设计

- $表的行数-1\ge所有因子以及需要考察的交互作用的自由度之和$
- $表的列数＞因子个数与要考察的交互作用个数的和$
- $因子自由度与交互作用自由度=所在列的自由度$
- $列自由度=列水平数-1$
- 交互作用列要根据交互正交表来进行放置,不可随意放置

#### 统计量计算

- 计算$\bar y=\frac{1}{n}\sum_{i=1}^ny_i$
- 计算$S_T=\sum_{i=1}^{n}(y_i-\bar y)^2$
- 计算$T_{ij}=第i列水平j所在行对应的观察值的和$
- 计算$S_j=\frac{n}{q}\sum_{j=1}^q(\bar T_{ij}-\bar y)^2,n为表行数,q为对应列的水平数$
- 计算$S_e=空白列的平方和的和$
- $f_e=空白列的自由度之和,f_j=对应列的水平数-1,f_T=n-1$
- 计算$MSE=\frac{S_e}{f_e},MSJ=\frac{S_j}{f_j}$
- 计算$F=\frac{MSJ}{MSE}$

#### 最佳水平组合

##### 交互作用

- 前提:当$A,B$的交互作用显著时,我们只需要确定其最优秀的交互作用即可,不用再分别确定$A,B$最优秀的水平==(见Page 127)==
- 从正交实验表中把A,B的四个不同交互作用对应的观察值找出来,算出四个交互作用所对应的观察值的平均值
- 四个观察值的平均值中最大的那个对应的交互作用组合即为最优组合

##### 显著因子	

- 找到因子各个水平观察值的均值的最大值
- 这个最大值对应的水平就是该因子对应的最佳水平

#### 区间估计

- 计算$n_e=\frac{实验次数}{1+显著因子的自由度的和}$
- 计算$S_e^{'}=S_e+不显著因子的平方和$
- 计算$f_e^{'}=f_e+不显著的因子的自由度之和$
- 计算$\hat\sigma=\sqrt{\frac{S_e^{'}}{f_e^{'}}}$
- 区间=$\hat\mu_{···}±\frac{t_{\frac{1-\alpha}{2}}(f_e^{'})\hat\sigma}{\sqrt{n_e}}$

### 2.4 有重复的正交设计

#### 表头设计

- 与前面相同

#### 统计量计算

- 计算$y_i=\sum_{j=1}^my_{ij}$

- 计算$\bar y=\frac{1}{mn}\sum_{i=1}^n\sum_{j=1}^my_{ij}$
- 计算$\bar y_i=\frac{y_i}{m}$
- 计算$S_T=\sum_{i=1}^{n}\sum_{j=1}^m(y_{ij}-\bar y)^2$
- 计算$S_l=\frac{n}{q}\sum_{j=1}^q(\bar T_{lj}-y),q为对应列的水平数,l为列,n为表的行数$
- 计算$S_内=\sum_{i=1}^n\sum_{j=1}^m(y_{ij}-\bar y_i)$
- 计算$S_间=S_1+S_2+\cdots+S_l$
- 计算$\begin{array}{l}f_l=对应列水平数-1\\f_内=n(m-1)\\f_间=f_1+f_2+\cdots f_l\\f_T=n-1\end{array}$
- 进行模型检验

#### 模型检验

- 前提:我们的$S_内$为纯误差,而我们的所有的空白列中是可能包含误差与交互作用的,因此我们需要对空白列进行方法分析,检验其交互作用的显著性,如果结果为不显著,那么我们可以将该不显著的空白列归入纯误差中
- :package: 检验方法一
  - 先整体检验空白列整体是否显著,如果显著则进行下一步,不显著则直接把这些空白列归入纯误差
  - 直接观察空白列对应的$S_j$的值,这个值越大则表明其越可能包含交互作用,去除它
  - 检验剩下的空白列的整体是否显著,如果显著则重复上一步,不显著则把这些空白列(不包括被剔除掉的)归入纯误差

- :secret: 检验方法二
  - 分别对每一个空白列做方差分析,去除显著的,不显著的则归入纯误差


- :orange:**原理**:如果空白列不包含交互作用而只包含误差,那么其分布就应该与纯误差分布相同,因此其误差均方和与纯误差均方和应该服从概率近似

#### 最优水平组合

与前面类似

#### 区间估计

与前面类似

#### 示例

<img src="C:\Users\Administrator\Desktop\Typora文档\试验设计\1649918495375.jpg.jpg" alt="1649918495375.jpg" style="zoom:15%;" />

<img src="C:\Users\Administrator\Desktop\Typora文档\试验设计\1649918541296.jpg.jpg" alt="1649918541296.jpg" style="zoom:20%;" />

<img src="C:\Users\Administrator\Desktop\Typora文档\试验设计\1649918633465.jpg.jpg" alt="1649918633465.jpg" style="zoom:15%;" />

<img src="C:\Users\Administrator\Desktop\Typora文档\试验设计\1649918937973.jpg.jpg" alt="1649918937973.jpg" style="zoom:15%;" />

### 2.5 水平数不等情况下的正交试验设计

#### 概念

当不同的因子具备不同的水平时,我们就需要重构我们的正交表(我们的正交表只能检验水平数相等的情况).以适配这一情况.而改造的方法有并列法,拟水平法,组合法,赋闲列法,裂区法

#### 并列法

- :heart: 前提:并列法得到的正交表为不完全正交表
- :rainbow: 注意事项:基本运算过程其实与我们前面的正交表都相同,只不过我们此时的正交表为不完全正交表,因此需要通过$S_T-\sum S_j$求得纯误差$S_{e'}$,然后再以与类似重复实验情形下的方法对正交表的每一列进行检验,将不显著的列归入纯误差,当然纯误差的自由度也要获得相应增加,然后再进行方差分析
- **实例**                          <img src="C:\Users\Administrator\Desktop\Typora文档\试验设计\1649918100409.jpg.jpg" alt="1649918100409.jpg" style="zoom:25%;" />
- <img src="C:\Users\Administrator\Desktop\Typora文档\试验设计\1649918208261.jpg.jpg" alt="1649918208261.jpg" style="zoom:15%;" />

#### 拟水平法

#### 组合法

#### 赋闲列法

### 2.6 正交实验的注意事项

#### 完全正交表与不完全正交表

- 完全正交表有$S_T=S_1+S_2+\cdots+S_j$的特性
- 不完全正交表的$S_T\neq S_1+S_2+\cdots+S_j$,$S_T=S_1+S_2+\cdots+S_j+S_{e'}$,其中$S_{e'}为纯误差$

#### 正交表表头设计

- **对于完全正交表实验,我们必须保证因子个数小于表的列数,不然由于完全正交表的特性,就会导致我们无法求得$S_e$从而做不了F检验**
- 对于不完全正交表实验,则无$因子数<表列数$的强制规定
- $交互作用的自由度=因子A自由度×因子B自由度$
- $因子自由度=因子水平数-1$
- 在有重复的实验下$S_T=S_{组间}+S_{组内}$,而$S_{组间}=S_1+S_2+\cdots+S_j$,且$S_{组内}$为纯误差
- 有重复下的实验为非完全正交实验(总平方和不等于各列平方和之和)

#### 为什么要要求各个因子(以及交互作用)的效应的期望=0==[如$\alpha_1+\alpha_2+\alpha_3=0,\alpha为因子$]==?





## 例题

### 题1

> 请推导出单因子方差分析下的下面两个式子:
>
> - $E(S_E)=(n-r)\sigma^2$
> - $E(S_A)=(r-1)\sigma^2+\sum\limits_{i=1}^rm_i(\mu_i-\mu)^2$

### 题2

> 请推导出固定效应模型下的$\hat a_i$以及$\hat \mu$(提示可以使用最小二乘估计求解`即将我们的固定效应模型看作一个回归模型去拟合原数据`)
>
> - $y_{ij}=\mu+a_i+\epsilon_{ij}$